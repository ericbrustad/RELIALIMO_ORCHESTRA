<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RELIA LIMOâ„¢</title>
    <link rel="icon" href="favicon.png" />
    <!-- Load environment variables first -->
    <script src="env.js"></script>
    <link rel="stylesheet" href="my-office.css" />
    <link rel="stylesheet" href="accounts.css" />
    <link rel="stylesheet" href="quotes.css" />
    <link rel="stylesheet" href="calendar.css" />
    <link rel="stylesheet" href="user-menu.css" />
    <style>
      /* Main section visibility control */
      .app-main-section {
        display: none !important;
        opacity: 0;
        transition: opacity 0.15s ease-in-out;
      }
      .app-main-section.active {
        display: block !important;
        opacity: 1;
      }
      
      /* Smooth iframe transitions */
      .app-main-section iframe {
        transition: opacity 0.15s ease-in-out;
      }
      
      /* Ensure only one header shows */
      body {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- UNIFIED HEADER -->
      <header class="header">
        <div class="header-content">
          <div class="header-left">
            <h1 class="logo">RELIA<img src="https://rosebud.ai/assets/red-bull-logo.webp?5r88" alt="RELIA bull" class="logo-bull">LIMOâ„¢</h1>
          </div>
          <div class="main-nav">
            <button class="nav-btn" data-section="new-reservation"><span>New Reservation</span><span style="font-size: 24px;">â•</span></button>
            <button class="nav-btn" data-section="dashboard"><span>Farmout Dashboard</span><span style="font-size: 24px;">ğŸ </span></button>
            <button class="nav-btn active" data-section="office"><span>Office</span><span style="font-size: 24px;">ğŸ¢</span></button>
            <button class="nav-btn" data-section="accounts"><span>Accounts</span><span style="font-size: 24px;">ğŸ‘¤</span></button>
            <button class="nav-btn" data-section="calendar"><span>Calendar</span><span style="font-size: 24px;">ğŸ“…</span></button>
            <button class="nav-btn" data-section="quotes"><span>Quotes</span><span style="font-size: 24px;">ğŸ“‹</span></button>
            <button class="nav-btn" data-section="reservations"><span>Reservations</span><span style="font-size: 24px;">ğŸš—</span></button>
            <button class="nav-btn" data-section="dispatch"><span>Dispatch</span><span style="font-size: 24px;">ğŸš™</span></button>
            <button class="nav-btn" data-section="network"><span>Network</span><span style="font-size: 24px;">ğŸŒ</span></button>
            <button class="nav-btn" data-section="settle"><span>Settle</span><span style="font-size: 24px;">ğŸ’°</span></button>
            <button class="nav-btn" data-section="receivables"><span>Receivables</span><span style="font-size: 24px;">ğŸ“Š</span></button>
            <button class="nav-btn" data-section="payables"><span>Payables</span><span style="font-size: 24px;">ğŸ’³</span></button>
            <button class="nav-btn" data-section="memos"><span>Memos</span><span style="font-size: 24px;">ğŸ“</span></button>
            <button class="nav-btn" data-section="files"><span>Files</span><span style="font-size: 24px;">ğŸ“</span></button>
            <button class="nav-btn" data-section="tools"><span>Tools</span><span style="font-size: 24px;">ğŸ”§</span></button>
            <button class="nav-btn" data-section="reports"><span>Reports</span><span style="font-size: 24px;">ğŸ“ˆ</span></button>
          </div>

          <!-- User Menu (top-right) -->
          <div id="userMenuContainer"></div>
        </div>
      </header>

      <!-- FARMOUT DASHBOARD SECTION (User View, Driver View, Farm-out) -->
      <div id="dashboardSection" class="app-main-section">
        <iframe src="index-reservations.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- OFFICE SECTION -->
      <div id="officeSection" class="app-main-section active">
        <iframe src="my-office.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- ACCOUNTS SECTION -->
      <div id="accountsSection" class="app-main-section">
        <iframe src="accounts.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- CALENDAR SECTION -->
      <div id="calendarSection" class="app-main-section">
        <iframe src="calendar.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- QUOTES SECTION -->
      <div id="quotesSection" class="app-main-section">
        <iframe src="quotes.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- RESERVATIONS SECTION -->
      <div id="reservationsSection" class="app-main-section">
        <iframe src="reservations-list.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- DISPATCH SECTION -->
      <div id="dispatchSection" class="app-main-section">
        <iframe src="dispatch-grid.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- NETWORK SECTION -->
      <div id="networkSection" class="app-main-section">
        <iframe src="network.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- SETTLE SECTION -->
      <div id="settleSection" class="app-main-section">
        <iframe src="settle.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- RECEIVABLES SECTION -->
      <div id="receivablesSection" class="app-main-section">
        <iframe src="receivables.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- PAYABLES SECTION -->
      <div id="payablesSection" class="app-main-section">
        <iframe src="payables.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- MEMOS SECTION -->
      <div id="memosSection" class="app-main-section">
        <iframe src="memos.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- FILES SECTION -->
      <div id="filesSection" class="app-main-section">
        <iframe src="files.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- TOOLS SECTION -->
      <div id="toolsSection" class="app-main-section">
        <iframe src="tools.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- REPORTS SECTION -->
      <div id="reportsSection" class="app-main-section">
        <iframe src="reports.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- NEW RESERVATION SECTION -->
      <div id="new-reservationSection" class="app-main-section">
        <iframe src="reservation-form.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- CONFIRMED RESERVATION SECTION (VIEW MODE) -->
      <div id="confirmedReservationSection" class="app-main-section">
        <iframe src="confirmed-reservation.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>
    </div>

    <script>
      // Track which section is currently active to prevent redundant switches
      let currentActiveSection = 'office';
      const iframeCache = new Map();

      // Wire all navigation buttons with event delegation
      document.addEventListener('DOMContentLoaded', () => {
        // Check if user has a startup page preference and navigate there
        checkStartupPagePreference();
        
        const mainNav = document.querySelector('.main-nav');
        if (mainNav) {
          mainNav.addEventListener('click', (e) => {
            const target = e.target;
            const btn = target instanceof Element ? target.closest('.nav-btn') : null;
            if (btn && btn.dataset.section) {
              switchMainSection(btn.dataset.section);
            }
          });
        }
      });

      /**
       * Check for startup page preference and navigate if applicable
       */
      function checkStartupPagePreference() {
        try {
          // Only navigate from index.html, index-reservations.html, or root path
          const currentPath = (window.location.pathname || '').toLowerCase();
          let currentFile = currentPath.split('/').pop() || '';
          
          // Remove .html extension for comparison
          if (currentFile.endsWith('.html')) {
            currentFile = currentFile.replace('.html', '');
          }
          
          console.log('[StartupPage] ========== CHECKING STARTUP PAGE NAVIGATION ==========');
          console.log('[StartupPage] Current file (normalized):', currentFile);
          
          // Valid entry points for startup page navigation (normalized without .html)
          const validEntryPoints = ['index', 'index-reservations', ''];
          const isValidEntry = validEntryPoints.includes(currentFile) || !currentFile;
          console.log('[StartupPage] Is valid entry point?', isValidEntry);
          
          if (!isValidEntry) {
            console.log('[StartupPage] Not on a valid entry point, skipping navigation');
            return;
          }

          // Check if CompanySettingsManager is available
          if (!window.CompanySettingsManager) {
            console.log('[StartupPage] CompanySettingsManager not available yet');
            return;
          }

          console.log('[StartupPage] ===== LOADING SETTINGS =====');
          const settingsManager = new window.CompanySettingsManager();
          const startPage = settingsManager.getSetting('defaultStartPage');
          console.log('[StartupPage] Raw getSetting("defaultStartPage"):', startPage);
          const finalPage = startPage || 'reservations';
          console.log('[StartupPage] After fallback:', finalPage);

          // Map setting values to section names
          const STARTUP_SECTIONS = {
            'new-reservation': 'new-reservation',
            'farmout-dashboard': 'dashboard',
            'office': 'office',
            'accounts': 'accounts',
            'calendar': 'calendar',
            'quotes': 'quotes',
            'reservations': 'reservations',
            'dispatch': 'dispatch',
            'network': 'network',
            'settle': 'settle',
            'receivables': 'receivables',
            'payables': 'payables',
            'memos': 'memos',
            'files': 'files',
            'tools': 'tools',
            'reports': 'reports'
          };

          const section = STARTUP_SECTIONS[finalPage];
          console.log('[StartupPage] ===== SECTION LOOKUP =====');
          console.log('[StartupPage] Looking up section for:', finalPage);
          console.log('[StartupPage] Available sections:', Object.keys(STARTUP_SECTIONS));
          console.log('[StartupPage] Section lookup result:', section);
          
          // If we found a valid section and it's not the default, navigate to it
          if (section && section !== 'office') { // 'office' is the default
            console.log('[StartupPage] âœ… Navigating to startup section:', section);
            switchMainSection(section);
            return;
          }
          
          console.log('[StartupPage] Using default section (office)');
        } catch (error) {
          console.error('[StartupPage] Error checking startup page:', error);
        }
      }

      function switchMainSection(section) {
        const isNewReservationRequest = section === 'new-reservation';

        // Skip if already on this section unless forcing a fresh new reservation load
        if (currentActiveSection === section && !isNewReservationRequest) {
          console.log('â„¹ï¸ Already on section:', section);
          return;
        }

        console.log('Switching to section:', section);
        currentActiveSection = section;
        
        // Update nav button active state
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.section === section) {
            btn.classList.add('active');
          }
        });

        // Hide all sections
        document.querySelectorAll('.app-main-section').forEach(sec => {
          sec.classList.remove('active');
        });

        // Show selected section
        const sectionElement = document.getElementById(section + 'Section');
        if (sectionElement) {
          sectionElement.classList.add('active');
          console.log('âœ“ Activated section:', section);
          
          // For reservations, ensure we're on the list view but don't reload if already there
          if (section === 'reservations') {
            const reservationsIframe = sectionElement.querySelector('iframe');
            if (reservationsIframe) {
              const currentSrc = (reservationsIframe.src || '').toLowerCase();
              if (!currentSrc.includes('reservations-list.html')) {
                console.log('ğŸ”„ Loading reservations-list.html');
                reservationsIframe.src = 'reservations-list.html';
              } else {
                console.log('âœ“ Reservations iframe already on list view, no reload');
              }
            }
          } else if (section === 'new-reservation') {
            const reservationIframe = sectionElement.querySelector('iframe');
            if (reservationIframe) {
              console.log('ğŸ”„ Preparing fresh reservation form');
              reservationIframe.dataset.confNumber = '';
              delete reservationIframe.dataset.viewMode;
              const timestamp = Date.now();
              reservationIframe.src = `reservation-form.html?_new=${timestamp}`;
            }
          }
        } else {
          console.error('Section not found:', section + 'Section');
        }
      }

      // Listen for messages from iframes
      window.addEventListener('message', function(event) {
        // Handle reservation form signals
        if (event.data.action === 'reservationFormScriptLoaded') {
          console.log('ğŸ“¨ [iframeâ†’parent] Reservation form script loaded, readyState:', event.data.readyState);
        } else if (event.data.action === 'reservationFormInitialized') {
          console.log('ğŸ“¨ [iframeâ†’parent] Reservation form initialized, editMode:', event.data.editMode);
        }
        if (event.data.action === 'switchSection') {
          switchMainSection(event.data.section);
            if (event.data.section === 'reservations' && event.data.openConf) {
              // Give iframe time to load/become active before sending message
              setTimeout(() => {
                const reservationsIframe = document.querySelector('#reservationsSection iframe');
                if (reservationsIframe && reservationsIframe.contentWindow) {
                  console.log('ğŸ“¤ Sending openReservation message to reservations list:', event.data.openConf);
                  reservationsIframe.contentWindow.postMessage({
                    action: 'openReservation',
                    conf: event.data.openConf
                  }, '*');
                }
              }, 300);
            }
        } else if (event.data.action === 'openReservation') {
          // Handle opening a saved reservation from reservations-list iframe
          const confNumber = event.data.openConf || event.data.conf;
          // Switch to confirmed-reservation section (view mode) - NOT new-reservation
          switchMainSection('confirmedReservation');
          
          // Small delay to ensure section is visible
          setTimeout(() => {
            const reservationIframe = document.querySelector('#confirmedReservationSection iframe');
            if (reservationIframe) {
              // Store conf as data attribute on the iframe
              reservationIframe.dataset.confNumber = confNumber;
              reservationIframe.dataset.viewMode = 'true';
              // Load confirmed-reservation.html (view mode) instead of the edit form
              const timestamp = new Date().getTime();
              const encodedConf = encodeURIComponent(confNumber);
              reservationIframe.src = `confirmed-reservation.html?conf=${encodedConf}&_reload=${timestamp}`;
            }
          }, 50);
        } else if (event.data.action === 'newReservation') {
          // Handle new reservation request from reservation form
          switchMainSection('new-reservation');
          
          setTimeout(() => {
            const reservationIframe = document.querySelector('#new-reservationSection iframe');
            if (reservationIframe) {
              // Clear any stored conf number
              reservationIframe.dataset.confNumber = '';
              delete reservationIframe.dataset.viewMode;
              // Force reload to get a fresh blank form
              const timestamp = new Date().getTime();
              reservationIframe.src = `reservation-form.html?_new=${timestamp}`;
            }
          }, 50);
        } else if (event.data.action === 'editReservation') {
          // Handle edit mode request from confirmed-reservation iframe
          const confNumber = event.data.conf;
          // Switch to new-reservation section for editing
          switchMainSection('new-reservation');
          
          setTimeout(() => {
            const reservationIframe = document.querySelector('#new-reservationSection iframe');
            if (reservationIframe) {
              // Store conf as data attribute on the iframe
              reservationIframe.dataset.confNumber = confNumber;
              delete reservationIframe.dataset.viewMode;
              // Load reservation-form.html in edit mode
              const timestamp = new Date().getTime();
              reservationIframe.src = `reservation-form.html?_edit=${timestamp}`;
            }
          }, 50);
        } else if (event.data.action === 'switchToReservations') {
          // Switch back to reservations list
          switchMainSection('reservations');
        } else if (event.data.action === 'navigate') {
        } else if (event.data.action === 'switchToDashboard') {
          // Switch to dashboard first
          switchMainSection('dashboard');
          // Then send message to dashboard iframe to switch view
          setTimeout(() => {
            const dashboardIframe = document.querySelector('#dashboardSection iframe');
            if (dashboardIframe && dashboardIframe.contentWindow) {
              dashboardIframe.contentWindow.postMessage({
                action: 'switchView',
                view: event.data.view
              }, '*');
            }
          }, 100);
        } else if (event.data.action === 'navigateToSystemMapping') {
          // Switch to Office section
          switchMainSection('office');
          // Then send message to office iframe to navigate to System Settings > System Mapping
          setTimeout(() => {
            const officeIframe = document.querySelector('#officeSection iframe');
            if (officeIframe && officeIframe.contentWindow) {
              officeIframe.contentWindow.postMessage({
                action: 'navigateToSystemSettings',
                page: 'system-mapping'
              }, '*');
            }
          }, 100);
        }
      });
      
      // Utility to purge ghost reservations from localStorage
      window.purgeAllGhostReservations = function() {
        localStorage.removeItem('relia_reservations');
        sessionStorage.removeItem('relia_ghost_purge_v1');
        console.log('[ManualPurge] Cleared all cached reservations. Reloading...');
        location.reload();
      };
    </script>

    <!-- Authentication Protection & User Menu -->
    <script type="module" src="auth-guard.js"></script>
    <script type="module" src="user-menu.js"></script>
    
    <!-- Company Settings & Application -->
    <script src="CompanySettingsManager.js"></script>
    <script src="SettingsApplicationManager.js"></script>
  </body>
</html>
