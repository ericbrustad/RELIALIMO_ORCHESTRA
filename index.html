<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RELIA LIMOâ„¢</title>
    <link rel="icon" href="favicon.png" />
    <!-- Load environment variables first -->
    <script src="env.js"></script>
    <link rel="stylesheet" href="my-office.css" />
    <link rel="stylesheet" href="accounts.css" />
    <link rel="stylesheet" href="quotes.css" />
    <link rel="stylesheet" href="calendar.css" />
    <link rel="stylesheet" href="user-menu.css" />
    <style>
      /* Main section visibility control */
      .app-main-section {
        display: none !important;
      }
      .app-main-section.active {
        display: block !important;
      }
      
      /* Ensure only one header shows */
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
      }

      #app {
        height: 100%;
        overflow: hidden;
        width: 100%;
        max-width: none;
        margin: 0;
      }

      /* Shell header must be stationary across all sections.
         Some imported page CSS defines .header-content as centered (max-width + margin:auto),
         so we hard-override for the shell header specifically. */
      #app > header.header .header-content {
        max-width: none !important;
        width: 100% !important;
        margin: 0 !important;
      }

      /* Keep the shell from scrolling (prevents header "jitter" due to scrollbars).
         The iframes handle their own scrolling. */
      .app-main-section {
        height: calc(100vh - 60px);
        overflow: hidden;
      }

      /* Wide sections: use full browser width (no centered max-width header) */
      body.shell-wide .header-content {
        max-width: none !important;
        width: 100% !important;
      }
      body.shell-wide #app,
      body.shell-wide .app-main-section,
      body.shell-wide .app-main-section iframe {
        width: 100% !important;
        max-width: none !important;
      }

      .app-main-section iframe {
        width: 100% !important;
        height: 100% !important;
        border: none !important;
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- UNIFIED HEADER -->
      <header class="header">
        <div class="header-content">
          <div class="header-left">
            <h1 class="logo">RELIA<img src="https://rosebud.ai/assets/red-bull-logo.webp?5r88" alt="RELIA bull" class="logo-bull">LIMOâ„¢</h1>
          </div>
          <div class="main-nav">
            <button class="nav-btn" data-section="new-reservation"><span>New Reservation</span><span style="font-size: 24px;">â•</span></button>
            <button class="nav-btn" data-section="dashboard"><span>Farmout Dashboard</span><span style="font-size: 24px;">ğŸ </span></button>
            <button class="nav-btn active" data-section="office"><span>Office</span><span style="font-size: 24px;">ğŸ¢</span></button>
            <button class="nav-btn" data-section="accounts"><span>Accounts</span><span style="font-size: 24px;">ğŸ‘¤</span></button>
            <button class="nav-btn" data-section="calendar"><span>Calendar</span><span style="font-size: 24px;">ğŸ“…</span></button>
            <button class="nav-btn" data-section="quotes"><span>Quotes</span><span style="font-size: 24px;">ğŸ“‹</span></button>
            <button class="nav-btn" data-section="reservations"><span>Reservations</span><span style="font-size: 24px;">ğŸš—</span></button>
            <button class="nav-btn" data-section="dispatch"><span>Dispatch</span><span style="font-size: 24px;">ğŸš™</span></button>
            <button class="nav-btn" data-section="network"><span>Network</span><span style="font-size: 24px;">ğŸŒ</span></button>
            <button class="nav-btn" data-section="settle"><span>Settle</span><span style="font-size: 24px;">ğŸ’°</span></button>
            <button class="nav-btn" data-section="receivables"><span>Receivables</span><span style="font-size: 24px;">ğŸ“Š</span></button>
            <button class="nav-btn" data-section="payables"><span>Payables</span><span style="font-size: 24px;">ğŸ’³</span></button>
            <button class="nav-btn" data-section="memos"><span>Memos</span><span style="font-size: 24px;">ğŸ“</span></button>
            <button class="nav-btn" data-section="files"><span>Files</span><span style="font-size: 24px;">ğŸ“</span></button>
            <button class="nav-btn" data-section="tools"><span>Tools</span><span style="font-size: 24px;">ğŸ”§</span></button>
            <button class="nav-btn" data-section="reports"><span>Reports</span><span style="font-size: 24px;">ğŸ“ˆ</span></button>
          </div>
        </div>
      </header>

      <!-- FARMOUT DASHBOARD SECTION (User View, Driver View, Farm-out) -->
      <div id="dashboardSection" class="app-main-section">
        <iframe src="index-reservations.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- OFFICE SECTION -->
      <div id="officeSection" class="app-main-section active">
        <iframe src="my-office.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- ACCOUNTS SECTION -->
      <div id="accountsSection" class="app-main-section">
        <iframe src="accounts.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- CALENDAR SECTION -->
      <div id="calendarSection" class="app-main-section">
        <iframe src="calendar.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- QUOTES SECTION -->
      <div id="quotesSection" class="app-main-section">
        <iframe src="quotes.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- RESERVATIONS SECTION -->
      <div id="reservationsSection" class="app-main-section">
        <iframe src="reservations-list.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- DISPATCH SECTION -->
      <div id="dispatchSection" class="app-main-section">
        <iframe src="dispatch-grid.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- NETWORK SECTION -->
      <div id="networkSection" class="app-main-section">
        <iframe src="network.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- SETTLE SECTION -->
      <div id="settleSection" class="app-main-section">
        <iframe src="settle.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- RECEIVABLES SECTION -->
      <div id="receivablesSection" class="app-main-section">
        <iframe src="receivables.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- PAYABLES SECTION -->
      <div id="payablesSection" class="app-main-section">
        <iframe src="payables.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- MEMOS SECTION -->
      <div id="memosSection" class="app-main-section">
        <iframe src="memos.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- FILES SECTION -->
      <div id="filesSection" class="app-main-section">
        <iframe src="files.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- TOOLS SECTION -->
      <div id="toolsSection" class="app-main-section">
        <iframe src="tools.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- REPORTS SECTION -->
      <div id="reportsSection" class="app-main-section">
        <iframe src="reports.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- NEW RESERVATION SECTION -->
      <div id="new-reservationSection" class="app-main-section">
        <iframe src="reservation-form.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>
    </div>

    <script>
      // Cross-tab shell coordination so standalone pages don't remain open "behind" index.
      // Standalone pages can ask an existing shell tab to switch sections, then navigate away.
      (function setupShellCoordination() {
        const SECTION_ROUTES = {
          dashboard: 'index-reservations.html',
          office: 'my-office.html',
          accounts: 'accounts.html',
          quotes: 'quotes.html',
          calendar: 'calendar.html',
          'new-reservation': 'reservation-form.html',
          reservations: 'reservations-list.html',
          dispatch: 'dispatch-grid.html',
          network: 'network.html',
          settle: 'settle.html',
          receivables: 'receivables.html',
          payables: 'payables.html',
          memos: 'memos.html',
          files: 'files.html',
          tools: 'tools.html',
          reports: 'reports.html'
        };

        const isSafeRelativeUrl = (url) => {
          if (typeof url !== 'string') return false;
          const s = url.trim();
          if (!s) return false;
          if (/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(s)) return false;
          if (s.startsWith('//')) return false;
          if (s.includes('\\')) return false;
          if (s.includes('..')) return false;
          return true;
        };

        const isAllowedSectionUrl = (section, url) => {
          const base = SECTION_ROUTES[section];
          if (!base) return false;
          if (!isSafeRelativeUrl(url)) return false;
          const pathOnly = url.split('?')[0].split('#')[0];
          return pathOnly === base;
        };

        const applySectionSwitch = (section, url) => {
          try {
            if (section && typeof url === 'string' && url.length > 0 && isAllowedSectionUrl(section, url)) {
              const frame = document.querySelector(`#${CSS.escape(section)}Section iframe`);
              if (frame) frame.src = url;
            }
          } catch {
            // ignore
          }

          try {
            if (section) switchMainSection(section);
          } catch {
            // ignore
          }
        };

        // Heartbeat for other tabs to detect an existing shell.
        const beat = () => {
          try { localStorage.setItem('relia_shell_heartbeat', String(Date.now())); } catch { /* ignore */ }
        };
        beat();
        setInterval(beat, 1500);

        // BroadcastChannel (preferred)
        try {
          const bc = new BroadcastChannel('relia_shell');
          bc.addEventListener('message', (event) => {
            const data = event?.data || {};
            if (data.type === 'relia:shellPing' && data.id) {
              bc.postMessage({ type: 'relia:shellPong', id: data.id });
              return;
            }
            if (data.type === 'relia:openSection' && data.section) {
              applySectionSwitch(data.section, data.url || '');
            }
          });
        } catch {
          // ignore
        }

        // localStorage event fallback
        window.addEventListener('storage', (e) => {
          if (e.key !== 'relia_shell_switch' || !e.newValue) return;
          try {
            const msg = JSON.parse(e.newValue);
            if (msg && msg.section) applySectionSwitch(msg.section, msg.url || '');
          } catch {
            // ignore
          }
        });
      })();

      // Wire all navigation buttons with event delegation
      document.addEventListener('DOMContentLoaded', () => {
        const mainNav = document.querySelector('.main-nav');
        if (mainNav) {
          mainNav.addEventListener('click', (e) => {
            const btn = e.target.closest('.nav-btn');
            if (btn?.dataset.section) {
              switchMainSection(btn.dataset.section);
            }
          });
        }

        const SECTION_ROUTES = {
          dashboard: 'index-reservations.html',
          office: 'my-office.html',
          accounts: 'accounts.html',
          quotes: 'quotes.html',
          calendar: 'calendar.html',
          'new-reservation': 'reservation-form.html',
          reservations: 'reservations-list.html',
          dispatch: 'dispatch-grid.html',
          network: 'network.html',
          settle: 'settle.html',
          receivables: 'receivables.html',
          payables: 'payables.html',
          memos: 'memos.html',
          files: 'files.html',
          tools: 'tools.html',
          reports: 'reports.html'
        };

        const isSafeRelativeUrl = (url) => {
          if (typeof url !== 'string') return false;
          const s = url.trim();
          if (!s) return false;
          // Disallow absolute/protocol URLs and path traversal
          if (/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(s)) return false;
          if (s.startsWith('//')) return false;
          if (s.includes('\\')) return false;
          if (s.includes('..')) return false;
          return true;
        };

        const isAllowedSectionUrl = (section, url) => {
          const base = SECTION_ROUTES[section];
          if (!base) return false;
          if (!isSafeRelativeUrl(url)) return false;
          const pathOnly = url.split('?')[0].split('#')[0];
          return pathOnly === base;
        };

        // Support deep-links and standalone redirects: index.html?section=...
        try {
          const params = new URLSearchParams(window.location.search);
          const section = params.get('section');
          if (section) {
            // If someone provided an old-style &url=..., strip it and ignore.
            if (params.has('url')) {
              params.delete('url');
              const next = `${window.location.pathname}?${params.toString()}${window.location.hash || ''}`;
              try { history.replaceState({}, '', next); } catch { /* ignore */ }
            }

            // One-time internal override (not user-controllable via URL)
            try {
              const raw = sessionStorage.getItem('relia_nav_override');
              if (raw) {
                const ov = JSON.parse(raw);
                if (ov && ov.section === section && typeof ov.url === 'string' && isAllowedSectionUrl(section, ov.url)) {
                  const frame = document.querySelector(`#${CSS.escape(section)}Section iframe`);
                  if (frame) frame.src = ov.url;
                }
                sessionStorage.removeItem('relia_nav_override');
              }
            } catch {
              // ignore
            }

            switchMainSection(section);
          }
        } catch {
          // ignore
        }
      });

      function switchMainSection(section) {
        console.log('Switching to section:', section);

        // Track active section on the shell
        try {
          document.body.dataset.activeSection = section;
        } catch {
          // ignore
        }

        // Wide certain sections (full width, keep header)
        try {
          const wideSections = new Set([
            'new-reservation',
            'reservations',
            'accounts',
            'office',
            'quotes',
            'receivables'
          ]);
          document.body.classList.toggle('shell-wide', wideSections.has(section));
        } catch {
          // ignore
        }
        
        // Update nav button active state
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.section === section) {
            btn.classList.add('active');
          }
        });

        // Force hide all sections first - remove active class
        document.querySelectorAll('.app-main-section').forEach(sec => {
          sec.classList.remove('active');
        });

        // Show selected section
        const sectionElement = document.getElementById(section + 'Section');
        if (sectionElement) {
          sectionElement.classList.add('active');
          console.log('âœ“ Activated section:', section);
        } else {
          console.error('Section not found:', section + 'Section');
        }
      }

      // Expose for modules/pages that want to call into the shell
      window.switchMainSection = switchMainSection;

      // Listen for messages from iframes
      window.addEventListener('message', function(event) {
        if (event.data.action === 'relia:accountSaved') {
          // Forward to the reservation iframe so it can populate Billing with the saved account.
          try {
            const reservationIframe = document.querySelector('#new-reservationSection iframe');
            if (reservationIframe && reservationIframe.contentWindow) {
              reservationIframe.contentWindow.postMessage(event.data, '*');
            }
          } catch {
            // ignore
          }

          // If this save originated from the reservation flow, return user to New Reservation.
          try {
            const from = (event?.data?.from || '').toString().toLowerCase();
            if (from === 'reservation') {
              switchMainSection('new-reservation');
            }
          } catch {
            // ignore
          }
          return;
        }

        if (event.data.action === 'switchSection') {
          try {
            const section = event.data.section;
            const url = event.data.url;
            if (section && typeof url === 'string' && url.length > 0) {
              // Only allow the default route for that section (plus query/hash).
              const allowed = (function() {
                try {
                  const SECTION_ROUTES = {
                    dashboard: 'index-reservations.html',
                    office: 'my-office.html',
                    accounts: 'accounts.html',
                    quotes: 'quotes.html',
                    calendar: 'calendar.html',
                    'new-reservation': 'reservation-form.html',
                    reservations: 'reservations-list.html',
                    dispatch: 'dispatch-grid.html',
                    network: 'network.html',
                    settle: 'settle.html',
                    receivables: 'receivables.html',
                    payables: 'payables.html',
                    memos: 'memos.html',
                    files: 'files.html',
                    tools: 'tools.html',
                    reports: 'reports.html'
                  };

                  const isSafeRelativeUrl = (u) => {
                    if (typeof u !== 'string') return false;
                    const s = u.trim();
                    if (!s) return false;
                    if (/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(s)) return false;
                    if (s.startsWith('//')) return false;
                    if (s.includes('\\')) return false;
                    if (s.includes('..')) return false;
                    return true;
                  };

                  const base = SECTION_ROUTES[section];
                  if (!base) return false;
                  if (!isSafeRelativeUrl(url)) return false;
                  const pathOnly = url.split('?')[0].split('#')[0];
                  return pathOnly === base;
                } catch {
                  return false;
                }
              })();

              if (allowed) {
                const frame = document.querySelector(`#${CSS.escape(section)}Section iframe`);
                if (frame) frame.src = url;
              }
            }
          } catch {
            // ignore
          }
          switchMainSection(event.data.section);
        } else if (event.data.action === 'navigate') {
          // Navigate to a specific URL
          window.location.href = event.data.url;
        } else if (event.data.action === 'switchToDashboard') {
          // Switch to dashboard first
          switchMainSection('dashboard');
          // Then send message to dashboard iframe to switch view
          setTimeout(() => {
            const dashboardIframe = document.querySelector('#dashboardSection iframe');
            if (dashboardIframe && dashboardIframe.contentWindow) {
              dashboardIframe.contentWindow.postMessage({
                action: 'switchView',
                view: event.data.view
              }, '*');
            }
          }, 100);
        } else if (event.data.action === 'navigateToSystemMapping') {
          // Switch to Office section
          switchMainSection('office');
          // Then send message to office iframe to navigate to System Settings > System Mapping
          setTimeout(() => {
            const officeIframe = document.querySelector('#officeSection iframe');
            if (officeIframe && officeIframe.contentWindow) {
              officeIframe.contentWindow.postMessage({
                action: 'navigateToSystemSettings',
                page: 'system-mapping'
              }, '*');
            }
          }, 100);
        }
      });
    </script>

    <!-- Authentication Protection & User Menu -->
    <script type="module" src="auth-guard.js"></script>
    <script type="module" src="user-menu.js"></script>
  </body>
</html>
